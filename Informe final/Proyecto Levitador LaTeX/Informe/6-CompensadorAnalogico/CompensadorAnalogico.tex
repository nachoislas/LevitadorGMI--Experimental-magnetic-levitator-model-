\chapter{Compensador analógico} \chapterlabel{Informe/6-CompensadorAnalogico} \label{cap:Compensador Analogico}

En este capítulo se analiza la dinámica de la planta que se desea controlar y se utilizan distintas estrategias de análisis y compensación para conseguir que el sistema de levitación presente el comportamiento deseado. 

Como se mencionó en la sección \ref{sec_modelo_estados}, el fenómeno de levitación magnética presenta un comportamiento inestable. Es por ello que se debe implementar un lazo de control que logre estabilizar el sistema. Se propone una estrategia de control mediante la implementación de un compensador ($G_c$) dentro de un lazo de control interno y luego, un compensador ($G_{ext}$) en un lazo de control externo para mejorar su respuesta temporal. En la figura \ref{fig:diag-en-bloques-comp} se muestra un diagrama en bloques genérico de la estrategia compensación planteada.

\begin{figure}[H]
	\centering
	\scalebox{0.8}{\input{tikz/diagrama_general.tex}}
	\caption{Diagrama en bloques de estrategia de compensación propuesta.}	\label{fig:diag-en-bloques-comp}
\end{figure}

\section{Diseño del lazo de realimentación interno}

En esta sección se diseña el control del lazo de realimentación interno, que está compuesto por las etapas mostradas en la figura \ref{fig:diag-interno}. Donde $G_c$ corresponde a la transferencia del compensador que se desea diseñar, $G_{IL}$ a la transferencia del controlador de corriente, $G_p$ a la transferencia de la planta y $H_{estim}$ a la del estimador de distancia de entrehierro.


\begin{figure}[H]
	\centering
	\input{tikz/diagrama_lazo_interno.tex}
	\caption{Diagrama en bloques del lazo de compensación interno.}	\label{fig:diag-interno}
\end{figure}

Las funciones transferencia de cada bloque del diagrama \ref{fig:diag-interno} están dadas por:

\begin{equation*}
	G_{IL}(s) =\frac{I_L[A]}{V_{IL_{ref}}[V]}=\frac{6}{1+\frac{s}{12.17}}
\end{equation*}

\begin{equation*} 
	G_{p}(M,s)=\frac{Y_g[m]}{I_L[A]}=-\sqrt{\frac{30}{M}}*\frac{1.201}{s^{2}-4900}
\end{equation*}

\begin{equation*} 
	H_{estim}(s)=\frac{V_{estim}[V]}{Y_{g}[m]}=\frac{259.6}{(1+\frac{s}{1\:kr/s})}
\end{equation*}

La transferencia de lazo cerrado ($TLC_{interna}$) del diagrama \ref{fig:diag-interno} queda definida como:

\begin{equation}
	TLC_{interna}=\frac{Y_g[m]}{V_{ref_c}[V]}=\frac{G_c*G_{IL}*G_p}{1+G_c*G_{IL}*G_p*H_{estim}}
\end{equation}

A continuación se analiza la estabilidad de la planta considerando una masa $M=30\:kg$ y se diseña el bloque del compensador interno $G_c(s)$ para lograr estabilizarla. Luego, se verificará la estabilidad con este mismo compensador para una masa $M=1\:kg$, que corresponde a la mínima con la que trabaja el sistema.

\subsection{Análisis de estabilidad}

Para realizar el análisis de estabilidad se parte de las transferencias de la planta $G_{p}(s)$ para una masa de $30\:kg$, del controlador de corriente $G_{IL}(s)$ y del lazo de realimentación $H_{estim}(s)$. A partir de ellas se obtiene la transferencia a lazo abierto $GH_T(s)$ de la expresión \ref{eq_GT2}, que presenta cuatro polos, con uno de ellos con parte real positiva en $70\:r/s$.

\begin{equation*}
	GH_T(s)=G_{p}(s)*G_{iL}(s)*H_{estim}(s) 
\end{equation*}

\begin{equation} \label{eq_GT2}
		GH_T(s)=\frac{0.38}{(1-(\frac{s}{70\:r/s})^2)(1+\frac{s}{12.17\:r/s })(1+\frac{s}{1\:kr/s}) }	
\end{equation}


Para comenzar el análisis se considera un compensador $G_c=K$, donde K es una constante positiva. Por lo tanto, se plantea la transferencia de lazo abierto teniendo en cuenta el compensador:

\begin{equation} \label{eq_GT3}
	G_c*GH_T(s)=\frac{K*0.38}{(1-(\frac{s}{70\:r/s})^2)(1+\frac{s}{12.17\:r/s })(1+\frac{s}{1\:kr/s}) }	
\end{equation}

Utilizando la transferencia de la ecuación \ref{eq_GT3}, con $K=1$, se  grafican los diagramas de Bode y de Nyquist y, a partir de ellos, se analiza la estabilidad. Estos se muestran en las figuras \ref{fig:Diag_Bode_lazo_abierto_30kg} y \ref{fig:Diag_Nyquist_lazo_abierto_30kg} respectivamente.

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.8]{bode_planta_30kg.png}
	\caption{Diagrama de Bode de lazo abierto $G_c*GH_T$ con $M=\:30 kg$.}
	\label{fig:Diag_Bode_lazo_abierto_30kg}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.6]{nyquist_planta_30kg.png}
	\caption{Diagrama de Nyquist de $G_c*GH_T$ con $M=30\:kg$.}
	\label{fig:Diag_Nyquist_lazo_abierto_30kg}
\end{figure}


%\noindent Con la transferencia de la ecuación  \ref{eq_GT2} se  grafica el diagrama de Bode  en la figura \ref{fig:Diag_Bode_lazo_abierto_30kg}. El criterio de estabilidad de Bode dice que para determinar la estabilidad de un sistema en un diagrama de Bode se debe observar si la magnitud es mayor a 0dB antes de que la fase alcance -180°. En este caso nuestro sistema es de no mínima fase... \colorbox{red}{ver si dejamos esto o vamos directo a nyquist}

Como la transferencia de la planta $GH_T$ tiene un polo en el semiplano derecho del plano ``S'' no es posible determinar su estabilidad por medio del diagrama de Bode. Por lo tanto, se analiza la estabilidad por medio del criterio de Nyquist.

Como se observa en el diagrama en bloques de la figura \ref{fig:diag-interno}, para compensar al sistema se planteó una realimentación negativa. Por lo tanto, para analizar su estabilidad según Nyquist se deben determinar la cantidad de giros (N) de $G_c*GH_T$ alrededor del punto $-1+j0$ en la figura \ref{fig:Diag_Nyquist_lazo_abierto_30kg} y la cantidad de polos (P) en el semiplano derecho de la función transferencia $G_c*GH_T$. El sistema resultará estable si se cumple la condición \ref{eq_condicion_Nyquist}, donde Z representa la cantidad de ceros en el semiplano derecho de $1+G_c*GH_T(s)$.

\begin{equation}\label{eq_condicion_Nyquist}
	Z=N+P=0
\end{equation}


Debido a que $GH_T$ tiene un polo en el semiplano derecho ($P=1$) y no hay giros alrededor del punto $-1+j0$ ($N=0$), resulta que $Z=1$. Por lo tanto, la transferencia de lazo cerrado ($TLC_{interna}$) presenta un comportamiento inestable. En la figura \ref{fig:Diag_Nyquist_lazo_abierto_30kg} se puede observar que no existe ningún valor de $K>0$ que haga que el contorno de $G_c*GH_T$ rodee el punto $-1+j0$. Por lo tanto, se propone implementar un compensador con $K<0$, para invertir el contorno de $G_c*GH_T$. Esto resulta equivalente a considerar $K>0$ y usar realimentación positiva en el lazo de control interno. De esta forma se obtiene el diagrama en bloques de la figura \ref{fig:diag-interno_realimentacion_positiva}.


\begin{figure}[H]
	\centering
	\input{tikz/diagrama_lazo_interno_realimentacion_positiva.tex}
	\caption{Diagrama en bloques del lazo de compensación interno considerando realimentación positiva.}	\label{fig:diag-interno_realimentacion_positiva}
\end{figure}


La realimentación positiva se genera al sumar la señal $V_{estim}$ con la señal de entrada del sistema. La transferencia de lazo cerrado del diagrama en bloques ahora se define como:

\begin{equation}
	TLC_{interna}=\frac{Y_g[m]}{V_{ref_c}[V]}=\frac{G_c*G_{IL}*G_p}{1-G_c*G_{IL}*G_p*H_{estim}}
\end{equation}

Siguiendo el criterio de estabilidad de Nyquist, al utilizar realimentación positiva, la cantidad de giros (N) debe analizarse alrededor del punto $1+j0$. Si estos son en sentido horario, N será positivo, caso contrario será negativo. Al variar el valor de K, es posible hacer que el punto $1+j0$ quede contenido en la zona 1 o en la zona 2 de la figura \ref{fig:nyquist-con-zonas}. 

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.7]{nyquist_con_zonas.png}
	\caption{Diagrama de Nyquist con zonas marcadas.}	
	\label{fig:nyquist-con-zonas}
\end{figure}

Si el punto queda dentro de la zona 1, el número de giros es $N=1$. Por lo tanto, se plantea:

\begin{equation*}
	Z = N + P = 2
\end{equation*}


Si el punto queda dentro de la zona 2, el número de giros es $N=0$. Por lo tanto, se plantea:

\begin{equation*}
	Z = N + P = 1
\end{equation*}

Debido a que en ambas zonas Z resulta mayor que cero, el sistema realimentado no puede ser estabilizado con ningún valor de K. Para lograrlo se debe implementar un compensador $G_c$ que sea capaz de generar una zona en el diagrama de Nyquist donde exista un giro alrededor de $1 + j0$ en sentido antihorario de forma tal que $N=-1$ y resulte $Z=0$. Para ello, es necesario aumentar la fase para que pueda superar el valor de 0$\mathrm{{}^\circ}$. Para que esto se cumpla, el diagrama de Nyquist debe tener una forma como la  mostrada en la figura \ref{fig:nyquist-deseado-analog}.

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.7]{Nyquist-deseado-analog.png}
	\caption{Forma del diagrama de Nyquist deseado.}
	\label{fig:nyquist-deseado-analog}
\end{figure}

De esta manera se identifican cuatro zonas en las que puede estar ubicado el punto $1+j0$. Sin embargo, solo en la zona 2 se genera un giro en sentido antihorario ($N=-1$) como es deseado, por lo que resulta:

\begin{equation*}
	Z = N + P = 0
\end{equation*}

%Para lograr el comportamiento del sistema como en la figura 	\ref{fig:nyquist-deseado-analog} se debe tener en cuenta que el m\'{o}dulo de la transferencia de lazo abierto en el primer cruce de la fase por 0$\mathrm{{}^\circ}$ debe ser mayor a $0\:dB$ y, en el segundo cruce, menor. Para ello, se propone implementar un compensador por adelanto de fase.

A continuación se diseñará el compensador $G_c$ para lograr que el diagrama de Nyquist tenga la forma deseada y así, estabilizar el sistema.


\subsection{Diseño de compensador}

Para lograr el comportamiento del sistema como en la figura 	\ref{fig:nyquist-deseado-analog} se utilizará una estrategia de compensación por adelanto de fase. Esta consiste en observar el diagrama de bode de la figura \ref{fig:Diag_Bode_lazo_abierto_30kg} y elegir una frecuencia en la que se desee aumentar la fase para lograr la estabilidad. Se debe tener en cuenta que el módulo de la transferencia de lazo abierto en el primer cruce de la fase por 0$\mathrm{{}^\circ}$ debe ser mayor a $0\:dB$ y, en el segundo cruce, menor. 

De esta forma, al observar la figura \ref{fig:Diag_Bode_lazo_abierto_30kg} se decide generar un adelanto de fase de por lo menos 100° en la frecuencia $200\:r/s$. Esto se logra mediante el uso de un compensador compuesto por dos redes de adelanto de fase de 65$\mathrm{{}^\circ}$ cada una. 

Una red de adelanto de fase está compuesta por un polo ($W_p$) y un cero ($W_c$), de manera que el cero se encuentra a una frecuencia menor que el polo, permitiendo un aumento de fase a la frecuencia deseada $W_0$. Su transferencia es la siguiente:

\begin{equation}
	G_{af}(s)=\alpha*\frac{(s + W_c)}{(s + W_p)}
\end{equation}

\noindent De esta forma, las ecuaciones de dise\~{n}o resultan:

\begin{equation*}
	\begin{aligned}
		&W_0 =200\:r/s\\
		&{\varphi }_{max} =65\textrm{°}\\
		&\alpha =\frac{1+sen({\varphi }_{max})}{1-sen{(\varphi }_{max})}=20.346491\\
		&W_c =\frac{W_0}{\sqrt{\alpha }}=\ 44.3\:r/s\\
		&W_p =\sqrt{\alpha }*W_0=902.1\: r/s\\
	\end{aligned}
\end{equation*} 
\noindent Finalmente, agregando una ganancia K y considerando las dos redes de adelanto de fase, se llega a la transferencia del controlador:

\begin{equation}  
	G_c(s)=K*{[20.346*\frac{(s+44.3)}{(s+902.1)}]}^2
\end{equation} 

\noindent En la figura \ref{fig:bode-analog-compensado-para-k-1} se muestra el diagrama de bode de ${GH}_T*G_c$ con $K=1$. Se puede observar que se logró aumentar la fase de la manera deseada. Para finalizar el diseño del compensador se debe elegir un valor apropiado para la ganancia $K$.

La ganancia $K$ puede adoptar valores desde $15.7\:dB$ hasta $35.5\:dB$ aproximadamente. Al considerar que el sistema debe soportar una masa variable entre $1\:kg$ y $30\:kg$, y que la ganancia de la transferencia de la planta para $1\:kg$ es de $5.5$ veces ($14\:dB$) mayor que para $30\:kg$, se debe adoptar una ganancia del compensador que mantenga la estabilidad para estos dos casos. Es decir, la ganancia mínima es de $15.7\:dB$ y la máxima es de $35.5\:dB - 14\:dB = 21.5\:dB$. Por lo tanto, se elige que el cruce por cero de la ganancia se encuentre ahora en $88\:r/s$, lo que significa que $K=20\:dB\ \equiv \ 10\: veces$. Se elige este valor para priorizar la estabilidad para el caso de masa máxima, con la desventaja de que se obtiene un menor margen de fase para el caso de masa mínima. \colorbox{red}{capaz esto lo sacamos}


\begin{figure}[H]
	\centering
	\includegraphics[scale=0.85]{Bode-k-1-M-30.png}
	\caption{Diagrama de Bode de $GH_T*G_c$ para $K=1$ y $M=30\:kg$.}
	\label{fig:bode-analog-compensado-para-k-1}
\end{figure}

\noindent En la figura \ref{fig:bode-analog-compensado-para-k-10} se muestra el diagrama de Bode al considerar la ganancia del compensador. En ella se puede observar que se  cumple con el criterio de estabilidad, puesto que en el primer cruce por 0°, la magnitud es mayor a 0 dB y en el segundo cruce, menor. Además, en la figura \ref{fig:nyquist-analog-para-k-10} se grafica el diagrama de Nyquist para el sistema con el compensador. En él se puede ver que el punto $1+j0$ queda dentro de la zona en la que $N=-1$, que resulta en $Z=0$.

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.8]{Bode-k-10-M-30.png}
	\caption{Diagrama de Bode de $GH_{T}*G_c$ para $K=10$ y $M=30\:kg$.}
	\label{fig:bode-analog-compensado-para-k-10}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.8]{Nyquist-k-10-M-30.png}
	\caption{Diagrama de Nyquist de $GH_T*G_c$ para $K=\:10$ y $M=30\:kg$.}
	\label{fig:nyquist-analog-para-k-10}
\end{figure}


\subsection{Verificación de estabilidad con masa de 1 kg}

%\noindent Se verifica la estabilidad del sistema  para el caso en que la masa sea de $1\:kg$ con el compensador dise\~{n}ado para el caso de masa m\'{a}xima. Para ello, se analizan los diagramas de Bode y Nyquist mostrados en las figuras \ref{fig:bode-analog-para-M-1Kg} y \ref{fig:nyquist-analog-para-M-1Kg}. Adem\'{a}s, en la figura \ref{fig:respuesta-analog-al-escalon-para-M-1Kg} puede observarse la respuesta al escal\'{o}n. A partir de ellos, es posible verificar que el sistema resulta estable para todo el rango de masas en el que opera el sistema. 

\noindent Se verifica la estabilidad del sistema  para el caso en que la masa sea de $1\:kg$ con el compensador previamente diseñado. Para ello, se analizan los diagramas de Bode y Nyquist mostrados en las figuras \ref{fig:bode-analog-para-M-1Kg} y \ref{fig:nyquist-analog-para-M-1Kg}. A partir de ellos, es posible verificar que el sistema resulta estable para todo el rango de masas en el que opera el sistema. Sin embargo, se puede observar que el margen de fase es menor que 45°, por lo que el sistema puede presentar un transitorio con oscilaciones amortiguadas. A raiz de esto, se propone implementar un lazo de control externo que permita mejorar dicha respuesta.

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.80]{bodecompensado1kg.png}
	\caption{Diagrama de Bode de $GH_T*G_c$ para $M=1\:kg$.}
	\label{fig:bode-analog-para-M-1Kg}
\end{figure}


\begin{figure}[H]
	\centering
	\includegraphics[scale=0.55]{nyquistcompensado1kg.png}
	\caption{Diagrama de Nyquist de $GH_T*G_c$ para $M=1\:kg$.}
	\label{fig:nyquist-analog-para-M-1Kg}
\end{figure}

%\begin{figure}[H]
%	\centering
%	\includegraphics[scale=0.80]{rtaescaloncompensado1kg.png}
%	\caption{Respuesta al escalón para $M=1\:kg$.}
%	\label{fig:respuesta-analog-al-escalon-para-M-1Kg}
%\end{figure}

\subsection{Transferencia de lazo cerrado}


Finalmente se puede expresar la función transferencia del lazo de control interno como:
%
%-3.6301e05 (s+1000) (s+44.3)^2
%------------------------------------------------------------------
%(s+304.3) (s+115.6) (s^2 + 44.84s + 2588) (s^2 + 2352s + 1.498e06)


\begin{equation}
	TLC_{interna}(s)=\frac{Y_g}{V_{ref_c}}=\frac{G_c*G_{p}*G_{iL}}{1-G_c*G_{p}*G_{iL}*H_{estim}}
	%	\frac{-3.6301*}{den}
\end{equation}

Para el caso de trabajar con masa de $30\:kg$, la $TLC_{interna}$ resulta:

\begin{equation*}
	\resizebox{.99\hsize}{!}
	{
		$
		TLC_{interna}(s)=\frac{-3.6301*10^5(s+1000)(s+44.3)^2}{(s+304.3) (s+115.6) (s^2 + 44.84s + 2588) (s^2 + 2352s + 1.498*10^6)}
		$
	}
\end{equation*}


Para el caso de trabajar con masa de $1\:kg$, resulta:


\begin{equation*}
	\resizebox{.99\hsize}{!}
	{
		$
		TLC_{interna}(s)=\frac{-1.9883*10^6 (s+1000) (s+44.3)^2}{(s^2 + 88.82s + 2127) (s^2 + 18.19s + 2.117*10^5) (s^2 + 2709s + 2.142*10^6)}	
		$
	}
\end{equation*}



En las figuras \ref{fig:ubicacion_polos_y_ceros} y \ref{fig:ubicacion_polos_y_ceros_1kg} se muestra la ubicación de los polos y ceros de la $TLC_{interna}$ para el caso de masa de $30\:kg$ y $1\:kg$, respectivamente. En ellas se ve que todos se encuentran en el semiplano izquierdo. 

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.85]{ubicacion_polos_ceros.png}
	\caption{Ubicación de polos y ceros de la transferencia de lazo cerrado interna con $M=30\:kg$.}
	\label{fig:ubicacion_polos_y_ceros}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.85]{ubicacion_polos_ceros_1kg.png}
	\caption{Ubicación de polos y ceros de la transferencia de lazo cerrado interna con $M=1\:kg$.}
	\label{fig:ubicacion_polos_y_ceros_1kg}
\end{figure}


Es importante notar que la ganancia de la transferencia de lazo cerrado en ambos casos es negativa. Esto debe tenerse en cuenta para el diseño del lazo de compensación externo.


%Por último se simuló la respuesta del sistema a un escalón de amplitud unitaria en la señal $V_{ref_c}$. La salida es un valor de distancia de entrehierro $Y_g$ en metros. En la figura \ref{fig:rta-escalon-k-10-m-30} se puede observar la respuesta al escalón del sistema con masa de $30\:kg$.
%
%\colorbox{red}{Ver como acomodar lo de la respuesta al escalon (y para 1kg tambien)}
%
%\begin{figure}[H]
%	\centering
%	\includegraphics[scale=0.80]{Respuesta-al-escalon-K-10-M-30Kg.png}
%	\caption{Respuesta al escalón para $M=30\:kg$.}
%	\label{fig:rta-escalon-k-10-m-30}
%\end{figure}

\section{Diseño del lazo de realimentación externo}

\noindent Se plantea un lazo de realimentación externo como se muestra en la figura \ref{fig:diag-externo}. 

\begin{figure}[H]
	\centering
	\input{tikz/diagrama_lazo_externo_simplificado.tex}
	\caption{Diagrama en bloques del lazo de compensación externo.}	\label{fig:diag-externo}
\end{figure}

En el lazo de realimentación interno actúa el compensador por adelanto de fase previamente diseñado y, en el externo, un controlador del tipo integral. Esto permite suavizar la respuesta al escalón del sistema y eliminar el error en régimen permanente.


\noindent Para el an\'{a}lisis se considera como realimentaci\'{o}n: 

\[H_{estim}=\frac{V_{estim}}{Y_g[m]}= \frac{259.6}{(1 + \frac{s}{1\:k})
}\] 

\noindent La cadena de avance con masa de $30\:kg$ es:

\begin{equation} \label{eq_cadena_avance_integrador}
	G=TLC_{interna}(s)[M=30\:kg]*G_{ext}
\end{equation}

La transferencia a lazo abierto resulta:

\begin{equation} \label{eq_lazo_abierto_externo}
	GH_{externo}=TLC_{interna}(s)[M=30\:kg]*G_{ext}*H_{estim}
\end{equation}

Inicialmente se plantea un compensador del tipo integrador cuya transferencia es:
\begin{equation}
	G_{ext}= \frac{K_{int}}{s}
\end{equation}

El problema de este integrador es que presenta una ganancia infinita en continua. Por lo tanto, se propone implementar un compensador con un polo ($p_{int}$) en baja frecuencia, que actúe como integrador a las frecuencias de la planta, pero que tenga ganancia finita en continua. De esta forma, se decide ubicar el polo en $0.1\:rad/s$ y la transferencia a implementar resulta:

\begin{equation}
	G_{ext}=\frac{K_{int}}{1+\frac{s}{p_{int}}}=\frac{K_{int}}{1+\frac{s}{0.1\:r/s}}	
\end{equation}

Sin embargo, es importante tener en cuenta que la ubicación de un polo en baja frecuencia provoca que la cancelación del error en régimen permanente no sea completa.

\colorbox{red}{Ver de verificar el error al escalón mas adelante y referenciarlo a esta parte}
%, pero de todas maneras sea pequeña en comparación con la distancia de separación.

%Debido a que no usamos un integrador ideal, la respuesta al escalón presentará un cierto error.
Para encontrar el valor adecuado de $K_{int}$ se grafica el lugar de raíces de la expresión \ref{eq_lazo_abierto_externo} considerando $K_{int}=1$. Este puede verse en la figura \ref{fig:lugar-de-raices-con-integrador-analog_inestable}.

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.7]{rlocusconintegrador30kg_inestable.png}
	\caption{Lugar de raíces de $GH_{externo}$}.
	\label{fig:lugar-de-raices-con-integrador-analog_inestable}
\end{figure}

Para determinar el valor de ganancia $K_{int}$ máxima a partir del cual el polo se pasa al semiplano derecho, se realiza un acercamiento al lugar de raíces que se muestra en la figura \ref{fig:lugar-de-raices-con-integrador-analog_inestable_acercamiento}. 

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.7]{rlocusconintegrador30kg_inestable_acercamiento.png}
	\caption{Acercamiento del lugar de raíces de $GH_{externo}$.}
	\label{fig:lugar-de-raices-con-integrador-analog_inestable_acercamiento}
\end{figure}

En la figura \ref{fig:lugar-de-raices-con-integrador-analog_inestable_acercamiento} se observa que el valor máximo de ganancia es $K_{int}=0.74$. Si bien el sistema resultaría estable para valores menores a este, su respuesta temporal sería demasiado lenta. 

Por lo tanto, se propone utilizar realimentación positiva en el diagrama en bloques de la figura \ref{fig:diag-externo}, obteniendo así el que se muestra la figura \ref{fig:diag-externo_real_positiva}. De esta forma, el polo de baja frecuencia cambia el sentido de desplazamiento y el lugar de raíces resulta como se muestra en la \ref{fig:lugar-de-raices-con-integrador-analog}.


\begin{figure}[H]
	\centering
	\input{tikz/diagrama_lazo_externo_realim_positiva.tex}
	\caption{Diagrama en bloques del lazo de compensación externo con realimentación positiva.}	
	\label{fig:diag-externo_real_positiva}
\end{figure}


\begin{figure}[H]
	\centering
	\includegraphics[scale=0.5]{rlocusconintegrador30kg.png}
	\caption{Lugar de raíces con realimentación positiva.}
	\label{fig:lugar-de-raices-con-integrador-analog}
\end{figure}
 
\noindent En la figura \ref{fig:lugar-de-raices-con-integrador-analog} se puede observar que, para que se mantenga la estabilidad del sistema, la ganancia del integrador ($K_{int}$) debe ser menor a 669. Teniendo esto en cuenta, en la figura \ref{fig:respuesta-al-escalon-con-k-1-M-30-analog} se muestra la respuesta al escalón del sistema compensado con el integrador para una ganancia de $K_{int}=1$. Por otro lado, para obtener una salida positiva es necesario considerar el bloque F del diagrama \ref{fig:diag-externo_real_positiva} como una ganancia unitaria negativa.

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.8]{stepresponseintegradorkint_1_m_30.png}
	\caption{Respuesta al escalón con integrador con $K_{int} =1$ y $M=30\:kg$.}
	\label{fig:respuesta-al-escalon-con-k-1-M-30-analog}
\end{figure}

Al observar la figura \ref{fig:respuesta-al-escalon-con-k-1-M-30-analog} es posible notar que la respuesta al escalón, si bien no posee oscilaciones, tiene un tiempo de establecimiento de aproximadamente $16.6 \:s$. Por lo tanto, para que el sistema presente mayor velocidad de respuesta, se decide aumentar el valor de ganancia hasta obtener una relación aceptable entre este tiempo y el sobrepico.



\noindent En la figura \ref{fig:respuesta-al-escalon-con-k-50-M-30}, se observa la respuesta al escalón para una ganancia del integrador de $K_{int}=50$ que resulta en un tiempo de establecimiento de $0.6\:s$ y un sobrepico de 0\%. Por lo tanto, se adopta este valor de ganancia para el diseño del integrador.

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.8]{stepresponseintegradorkint_50_m_30.png}
	\caption{Respuesta al escalón con integrador para $K_{int}=50$ y $M = 30\:kg$.}
	\label{fig:respuesta-al-escalon-con-k-50-M-30}
\end{figure}

\noindent La respuesta al escal\'{o}n cuando la masa es de $1 \:kg$ se muestra en la figura \ref{fig:respuesta-al-escalon-con-k-50-M-1}. All\'{i} se puede observar que el tiempo de establecimiento es de $0.74\:s$ y que no presenta sobrepicos.

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.85]{stepresponseintegradorkint_50_m_1.png}
	\caption{Respuesta al escalón con integrador para $K_{int} =50$ y $M = 1 \:kg$.}
	\label{fig:respuesta-al-escalon-con-k-50-M-1}
\end{figure}

Si bien para estas simulaciones se consideró que $F=-1$, a continuación se realiza el análisis para darle un valor mas apropiado.

\section{Cálculo de ganancia de entrada F}

Para que la tensión de referencia de posición $V_{y_{ref}}$ se corresponda con el valor deseado de distancia de entrehierro $Y_g$ se utiliza el bloque nombrado F en la figura \ref{fig:diag-externo_real_positiva}. 

Como se vio en la sección \ref{seccopn-estim-completo} la salida del estimador para cada valor de posición toma los  valores mostrados en la tabla \ref{tab_Resultados_de_simulación_del_estimador}. Estos fueron obtenidos a partir de la siguiente ecuación:

\begin{equation}
	V_{estim}=Y_g*H_{estim}+3.4V
\end{equation}


Por lo tanto se utilizan los mismos valores de $V_{estim}$ para la tensión de entrada $V_{y_{ref}}$. De esta forma, se obtiene la tabla \ref{tension-ref-vs-separacion-deseada}.

\begin{table}[H]
	\begin{center}
		\begin{tabular}{| c | c |}
			\hline
			$Y_{g_{deseado}}\:[mm]$ & $V_{y_{ref}}[V]$\\ \hline
			2 &	3.92 \\ \hline
			3 & 4.18\\ \hline
			4 & 4.44 \\ \hline
			5 & 4.7\\ \hline
		\end{tabular}
		\caption{Tensión de referencia $[V_{y_{ref}}]$ Vs separación deseada [$Y_g$].}
		\label{tension-ref-vs-separacion-deseada}
	\end{center}
\end{table}

Debido a que en la compensación del lazo externo se utiliza un integrador no ideal, se producirá error en la posición de salida $Y_g$ con respecto a la tensión de referencia  $V_{y_{ref}}$ en régimen permanente. Sin embargo, es posible elegir un valor de F para que este error sea nulo para un determinado valor de tensión de entrada. Por lo tanto, se decide eliminar el error para una posición de salida de $4\:mm$.

Para calcular el valor de F adecuado se debe obtener el valor en régimen permanente de la señal $V_{e_{ext}}$ mostrada en el diagrama de la figura \ref{fig:lugar-de-raices-con-integrador-analog}. Este puede ser calculado como:

\begin{equation} \label{eq_veext_ss}
	Ve_{ext_{ss}}=\frac{V_{y_{ref}}*F}{1-k_p}
\end{equation}

Donde: 

\begin{equation*}
	k_p=\lim\limits_{s \to 0}[G_{ext}(s)*TLC_{interna}(s)*H_{estim}(s)]=-67.78
\end{equation*}

La señal $Ve_{ext}$ puede calcularse como:

\begin{equation} \label{eq_veext_2}
	Ve_{ext}=V_{y_{ref}}*F+V_{estim}
\end{equation}

Entonces, al diseñar F tal que la salida para $4\:mm$ coincida con el valor en la referencia ($V_{y_{ref}}=4.44\:V$), resulta  $V_{estim}=4.44\:V$. A partir de las ecuaciones \ref{eq_veext_ss} y \ref{eq_veext_2} se plantea:

\begin{equation}
	V_{y_{ref}}*F+V_{estim}=\frac{V_{y_{ref}}*F}{1-k_p}
\end{equation}

Al despejar el valor de F se obtiene:

\begin{equation}
	F=-\frac{V_{y_{ref}}}{V_{estim}}*\frac{1}{1-\frac{1}{1-k_p}}=-1.015
\end{equation}


En la tabla asdasd se muestra el valor de salida $Y_{g_{real}}$ obtenido para cada valor de $V_{y_{ref}}$ en la entrada.

\begin{table}[H]
	\begin{center}
		\begin{tabular}{| c | c | c | c |}
			\hline
			$Y_{g_{deseado}}\:[mm]$ & $V_{y_{ref}}[V]$& $V_{estim}[V]$& $Y_{g_{real}}\:[mm]$\\ \hline
			2 &	3.92 & 3.9179 & 1.99 \\ \hline
			3 & 4.18 & 4.1778 & 2.99\\ \hline
			4 & 4.44 & 4.43 & 3.99 \\ \hline
			5 & 4.7 & 4.697 & 4.99\\ \hline	
		\end{tabular}
		\caption{Tensión de referencia $[V_{y_{ref}}]$ Vs separación deseada [$Y_g$].}
		\label{tension-ref-vs-separacion-deseada}
	\end{center}
\end{table}

Los valores de $V_{estim}$ y $Y_{g_{real}}$ fueron calculados como:

\begin{equation}
	V_{estim}=V_{y_{ref}}*F*(\frac{1}{1-k_p}-1)
\end{equation}

\begin{equation}
	Y_{g_{real}}=\frac{V_{estim}-3.4\:V}{H{estim}(s=0)}
\end{equation}


%La realimentación tiene un punto de operación de $3.4\:V$. Por lo tanto, se le suma a $V_{y_{ref}}$ el mismo valor.

Finalmente se puede expresar la función transferencia del lazo de control externo como:

\begin{equation}
	TLC_{externa}(s)=\frac{Y_g}{V_{y_{ref}}}=\frac{G_{ext}*TLC_{interna}}{1-G_{ext}*TLC_{interna}*H_{estim}}
	%	\frac{-3.6301*}{den}
\end{equation}

\begin{equation*}
\resizebox{.99\hsize}{!}
{
$
TLC_{externa}(s)=\frac{-1.8151e06 (s+44.3)^2 (s+1000)}{(s+311.7) (s+108) (s+6.128) (s^2 + 39.85s + 3039) (s^2 + 2351s + 1.497e06)}
$
}
\end{equation*}

\colorbox{red}{me parece que no se puede calcular la tlc sin antes calcular el F. podríamos dejar F genérico arriba.}




\section{Cálculo de ganancia de entrada F}

Para poder mapear correctamente la tensión de referencia de posición $V_{y_{ref}}$ con el valor deseado de distancia de entrehierro $Y_g$ se utiliza el bloque nombrado F en la figura \ref{fig:diag-externo_real_positiva}. Es necesario diseñar qué valor de ganancia tendrá para lograr la correspondencia.

Antes de diseñar el bloque F se debe caracterizar cómo será la señal en su entrada $V_{y_{ref}}$. Como se diseñó el sistema para tener error nulo en régimen permanente, es apropiado diseñar la señal de referencia para que coincida con la salida del estimador de distancia de entrehierro. Por lo tanto, como se vio en la sección \ref{seccopn-estim-completo} la salida del estimador para cada valor de posición toma los  valores mostrados en la tabla \ref{tab_Resultados_de_simulación_del_estimador}. Por lo tanto se mapea la tensión de entrada $V_{y_{ref}}$ con los mismos valores que toma $V_{estim}$ para cada $Y_{g}$ .

\colorbox{red}{recordar que $V_{estim}=H_{estim}*Y_g+3.4\:V$??}

Entonces en este caso se está suponiendo que en régimen permanente $V_{y_{ref}}$ y $V_{estim}$ toman el mismo valor... es decir queremos que $TLC_{externa_{ss}}=\frac{1}{H_{estim}}$

Los valores finales son:

\colorbox{red}{¿Agregamos los valores de salida teóricos? como para comparar el error?... podríamos agregar en la tabal de abajo una columna para el valor teórico y otra para el error relativo}

Para diseñar el bloque F se debe obtener la ganancia de la $TLC_{externa}$ correspondiente a su valor de continua. Resulta:

\begin{equation} 
	TLC_{externa_{ss}}=-1*\frac{F}{H_{estim}} = -1*\frac{F}{259.6}
\end{equation}

Por lo tanto, como se mencionó en el comienzo de esta sección, para obtener $TLC_{externa_{ss}}=\frac{1}{H_{estim}}$ resulta que $F=-1$.  \colorbox{red}{en realidad mas o menos... hay un muy pequeño error que podríamos haber cancelado con F, pero ya fue sino}

%la con el bloque $F$ mostrado en la figura \ref{fig:diag-externo_real_positiva} con un valor de $-1$ y los rangos de posición de $2\:mm$ a $5\:mm$ como mínimo y máximo respectivamente se llega a lo siguiente:

\begin{equation} 
	Y_g[m] = F * (-\frac{1}{259.6})*V_{y_{ref}} =\frac{1}{259.6}*V_{y_{ref}} 
\end{equation}





%La realimentación tiene un punto de operación de $3.4\:V$. Por lo tanto, se le suma a $V_{y_{ref}}$ el mismo valor.


\subsection{Error de posición en régimen permanente}

Como se diseñó un compensador externo que no es un integrador ideal, el sistema puede presentar cierto error en la distancia de entrehierro con respecto a la que se utiliza como referencia. En esta sección se calcula ese error para verificar que sea aceptable.

La señal $V_{e_{ext}}$ (del diagrama \ref{fig:diag-externo_real_positiva}), al estabilizarse el sistema en régimen permanente toma un valor que puede calcularse como:

\begin{equation*}
	V_{e_{ext_{ss}}}=\frac{1}{1-\lim\limits_{s \to 0}[G_{ext}*TLC_{interna}*H_{estim}]}=0.0145
\end{equation*}

Esta señal se puede escribir en función de la tensión de referencia y la realimentada como:

\begin{equation}
	V_{e_{ext_{ss}}}=V_{estim}+F*V_{y_{ref}}=V_{estim}-V_{y_{ref}}	
\end{equation}

Por lo tanto se puede armar una tabla que muestra la distancia de entrehierro que se obtiene para cada valor de señal de referencia....

\colorbox{red}{acá ponemos la tabla. me quedó +0.1mm de error para todas las posiciones}



\colorbox{red}{Ver q onda hacer la tabla de error que queremos con algo mas como para que este datos sea util y tener el valor constante que va a tomar el error para cada posición}

\section{Implementación circuital}

En esta sección se aborda el diseño circuital de la etapa de compensación, tanto de la red doble de adelanto de fase correspondiente al lazo de control interno, como el integrador correspondiente al lazo externo.

\subsection{Implementación circuital de la red de adelanto de fase}

\noindent Para cada etapa del compensador por adelanto se utiliza la topología mostrada en la figura \ref{fig:red-adelanto-fase}. Consiste en  un polo y un cero con ganancia unitaria (si $R_a = R_b$). Luego, se agrega la ganancia como una etapa separada.

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.55]{Red-adelanto-fase.png}
	\caption{Diseño circuital de una red de adelanto de fase.}
	\label{fig:red-adelanto-fase}
\end{figure}

\colorbox{red}{Ver punto de operacion..}

\noindent La transferencia de lazo cerrado de esta etapa es:

\begin{equation} 
	\frac{Vaf_{out}}{Vaf_{in}}= - \frac{R_a}{R_b}*\frac{1+sC(R_x+R_1)}{1+sCR_x}
\end{equation}

\noindent Por lo tanto, para tener un polo en $902.1\:Hz$ y un cero en $44.3\:Hz$, al elegir un capacitor $C = 1\:uF$, resulta en $R_x = 1100\:\Omega$ y $R_1 = 21.5\:k\Omega$. Además, se elige $R_a = R_b = 200\:k\Omega$ para obtener una ganancia unitaria. Luego, la ganancia del compensador se obtiene con una etapa amplificadora.
Para ello, se utiliza el circuito mostrado en la figura \ref{fig:ganancia-compensador}. Para lograr una ganancia de $K=10$ se utiliza $R_{322} = 1\:k\Omega$ y $R_{323} = 10\:k\Omega$.


\begin{figure}[H]
	\centering
	\includegraphics[scale=0.6]{Ganancia-compensador.png}
	\caption{Etapa de ganancia del compensador.}
	\label{fig:ganancia-compensador}
\end{figure}

\subsection{Implementación circuital del integrador}

\noindent En la figura \ref{fig:circuito-integrador} se puede observar la topología y los valores utilizados en cada componente para el diseño del circuito integrador.

\colorbox{red}{podríamos poner la transferencia genérica y calcular los componentes...} 

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.6]{Circuito-integrador.png}
	\caption{Implementación circuital del integrador.}
	\label{fig:circuito-integrador}
	\end{figure}


\subsection{Implementación circuital de la ganancia de entrada}


\noindent Para poder modificar la distancia de separación se ingresa al sistema con una tensión variable, la cual corresponde a una posición de referencia. Para ello se utiliza el circuito mostrado en la figura \ref{fig:etapa-de-entrada}.

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.8]{Etapa-de-entrada.png}
	\caption{ Etapa de entrada.}
	\label{fig:etapa-de-entrada}
\end{figure}

 
 \noindent Se utiliza una resistencia variable de $1\:k\Omega$ y dos con valores fijos. Para poder excursionar la tensión de referencia entre $3.92\:V$ y $4.7\:V$, los valores de las resistencias $R_1$ y $R_3$ deben ser de $4911\:\Omega$ y $313.5\:\Omega$ respectivamente. 
 
\noindent Por lo tanto, al adoptar un valor comercial para ellas, resulta en $R_1 = 316 \:\Omega$ y en $R_3 = 4990 \:\Omega$.
 
\noindent De esta forma, el valor de tensión máximo para la referencia de posición queda en $4.69\:V$ y el mínimo en $3.96\:V$.
 
